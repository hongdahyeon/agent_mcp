# OpenAPI 프록시 관리 가이드

이 문서는 내부 프록시 서버를 통해 외부 공공데이터 및 일반 OpenAPI를 등록, 관리 및 사용하는 방법을 설명합니다.

## 1. 내부 등록 및 사용 방법

### 1단계: API 등록

1. 메뉴에서 **설정 및 관리 > OpenAPI 관리**로 이동합니다.
2. **신규 API 등록** 버튼을 클릭합니다.
3. 다음 항목을 입력합니다:
   - **도구 ID (영문)**: 프록시 URL에 사용될 고유 식별자입니다 (예: `holiday_info`).
   - **API 한글명**: 화면에 표시될 직관적인 이름입니다.
   - **API URL**: 호출할 실제 외부 OpenAPI 엔드포인트 주소입니다.
   - **HTTP Method**: GET, POST_JSON, POST_FORM 중 선택합니다.
   - **인증 방식**:
     - **Service Key**: 공공데이터포털 방식입니다. 파라미터 이름(기본값: `ServiceKey`)과 실제 키 값을 입력합니다.
     - **Bearer Token**: 표준 헤더 기반 인증 방식입니다.
     - **None**: 인증이 필요 없는 공개 API입니다.
   - **Params Schema (JSON)**: API에서 사용하는 파라미터들을 JSON 객체로 정의합니다 (예: `{"solYear": "2024", "solMonth": "10"}`). 입력 시 테스트 모달에서 동적 입력 필드가 생성됩니다.
   - **첨부 파일**: API 명세서나 관련 기술 문서를 업로드하여 관리할 수 있습니다.
4. **저장하기**를 클릭합니다.

### 2단계: 테스트 및 검증

1. 등록된 목록 옆의 **Play (실행)** 아이콘을 클릭합니다.
2. 실행 모달이 열리면 다음 기능이 자동으로 작동합니다:
   - **동적 파라미터**: 설정한 `Params Schema`에 따라 입력 필드가 나타납니다.
   - **자동 인증**: 현재 로그인된 세션의 **JWT 토큰**이 내부 프록시 호출을 위해 자동으로 연결됩니다.
3. 테스트 값을 입력하고 **실행하기**를 클릭합니다.
4. 결과가 JSON 형식으로 표시됩니다. 대상 API가 **XML**을 반환하더라도 프록시 서버가 자동으로 JSON으로 변환합니다.
5. **결과 복사** 버튼을 통해 출력값을 간편하게 복사할 수 있습니다.

---

## 2. 외부 사용 방법 (API 연동)

내부 프록시 서버가 보안 키(Service Key 등)와 파일 인증을 대신 처리하므로, 외부 도구(Postman, 타 시스템)에서는 프록시 엔드포인트만 호출하면 됩니다.

### 엔드포인트 URL

프록시 URL 주소 체계는 다음과 같습니다:
`http://{서버_IP}:8000/api/execute/{tool_id}`

### 인증 (Authentication)

프록시 API 호출 시에는 반드시 이 시스템에서 발급한 유효한 토큰(`sk_...` 형식 또는 JWT)이 필요합니다. 보안을 위해 **Authorization 헤더** 방식을 권장합니다.

- **방식**: HTTP 헤더 (Authorization)
- **형식**: `Bearer <token>`
- **Example**:
  ```bash
  curl -H "Authorization: Bearer sk_abc123..." http://localhost:8000/api/execute/holiday_info
  ```

### 파라미터 전달 및 우선순위

프록시 URL로 전달된 파라미터는 실제 외부 API로 전달되며, 다음과 같은 우선순위를 가집니다:

1. **1순위 (최우선)**: 외부 호출 시 직접 넘겨준 Query Parameter 또는 Body 데이터
2. **2순위**: 넘겨준 파라미터가 없을 경우, **OpenAPI 관리** 메뉴에서 관리자가 입력한 `Params Schema (DB 기본값)`

### 주요 기능

- **자동 인증 주입**: 프록시 호출 시 등록된 Service Key나 Bearer 토큰이 서버 측에서 보안 상 안전하게 주입됩니다.
- **XML to JSON**: 응답이 XML인 경우 자동으로 JSON으로 변환되어 연동이 편리합니다.
- **보안 강화**: 실제 운영용 API 키가 클라이언트에 노출되지 않습니다.

---

## 3. 유지관리

- **파일 관리**: 등록 모달이나 목록의 '연동됨' 배지를 통해 첨부된 파일을 언제든 확인하고 삭제할 수 있습니다.
- **종속성**: XML 변환 기능을 위해 파이썬 환경에 `xmltodict` 라이브러리가 설치되어 있어야 합니다. (이미 `requirements.txt`에 포함됨)

---

## 4. AI 에이전트 연동 및 분석 기능 (New)

AI 에이전트가 OpenAPI 규격을 자동으로 파악하고 효율적으로 활용할 수 있도록 분석 전용 MCP 도구를 제공합니다.

### get_tool_analysis 도구

- **기능**: 특정 `tool_id`에 해당하는 OpenAPI의 상세 메타데이터와 실제 호출 결과를 분석하여 보고서를 생성합니다.
- **분석 항목**:
  - **도구 정보**: 서비스명, 설명, 엔드포인트 URL, HTTP 메서드
  - **인증 정보**: 서비스 키 또는 토큰 설정 여부
  - **파라미터 규격**: `Params Schema`에 따른 입력 항목 상세 (타입, 필수 여부)
  - **실제 응답 샘플**: 프록시를 통해 실제 URL을 호출한 결과 요약 (JSON 변환 결과 포함)
- **활용**: AI 에이전트가 도구를 사용하기 전, 어떤 파라미터가 필요한지 그리고 어떤 형식의 응답이 오는지 미리 학습하는 데 사용됩니다.

### 참고 자료 (Reference)

- [OpenAPI 에이전트 연동 분석 가이드 (Claude Share)](https://claude.ai/share/d0c16023-18ca-4939-a973-6ca795a800d4)
